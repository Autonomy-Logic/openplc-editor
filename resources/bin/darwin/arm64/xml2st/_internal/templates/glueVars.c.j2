
/********************************************************************************
 * Copyright (C) 2025 Autonomy
 *
 * This file is generated by xml2st.
 * Do not edit this file directly.
 * If you want to change the content, edit the jinja2 template
 * or the source PLC program and regenerate.
 ********************************************************************************/

// Include defines.h first for Arduino builds to set USE_*_BLOCKS macros
// before iec_std_FB.h processes its conditional includes
#ifdef ARDUINO
#include "../examples/Baremetal/defines.h"
#endif

#include "iec_std_lib.h"

#define __LOCATED_VAR(type, name, ...) type __##name;
#include "LOCATED_VARIABLES.h"
#undef __LOCATED_VAR
#define __LOCATED_VAR(type, name, ...) type* name = &__##name;
#include "LOCATED_VARIABLES.h"
#undef __LOCATED_VAR

TIME __CURRENT_TIME;
BOOL __DEBUG;
extern unsigned long long common_ticktime__;

#ifdef ARDUINO

    //OpenPLC Buffers
    #if defined(__AVR_ATmega328P__) || defined(__AVR_ATmega168__) || defined(__AVR_ATmega32U4__) || defined(__AVR_ATmega16U4__)

        #define MAX_DIGITAL_INPUT          8
        #define MAX_DIGITAL_OUTPUT         32
        #define MAX_ANALOG_INPUT           6
        #define MAX_ANALOG_OUTPUT          32
        #define MAX_MEMORY_WORD            0
        #define MAX_MEMORY_DWORD           0
        #define MAX_MEMORY_LWORD           0

        IEC_BOOL *bool_input[MAX_DIGITAL_INPUT/8][8];
        IEC_BOOL *bool_output[MAX_DIGITAL_OUTPUT/8][8];
        IEC_UINT *int_input[MAX_ANALOG_INPUT];
        IEC_UINT *int_output[MAX_ANALOG_OUTPUT];

        // Match pointer names with Linux version
        static IEC_BOOL *(*bool_input_ptr)[8] = bool_input;
        static IEC_BOOL *(*bool_output_ptr)[8] = bool_output;
        static IEC_UINT *(*int_input_ptr) = int_input;
        static IEC_UINT *(*int_output_ptr) = int_output;

    #else

        #define MAX_DIGITAL_INPUT          56
        #define MAX_DIGITAL_OUTPUT         56
        #define MAX_ANALOG_INPUT           32
        #define MAX_ANALOG_OUTPUT          32
        #define MAX_MEMORY_WORD            20
        #define MAX_MEMORY_DWORD           20
        #define MAX_MEMORY_LWORD           20

        IEC_BOOL *bool_input[MAX_DIGITAL_INPUT/8][8];
        IEC_BOOL *bool_output[MAX_DIGITAL_OUTPUT/8][8];
        IEC_UINT *int_input[MAX_ANALOG_INPUT];
        IEC_UINT *int_output[MAX_ANALOG_OUTPUT];
        IEC_UINT *int_memory[MAX_MEMORY_WORD];
        IEC_UDINT *dint_memory[MAX_MEMORY_DWORD];
        IEC_ULINT *lint_memory[MAX_MEMORY_LWORD];

        // Match pointer names with Linux version
        static IEC_BOOL *(*bool_input_ptr)[8] = bool_input;
        static IEC_BOOL *(*bool_output_ptr)[8] = bool_output;
        static IEC_UINT *(*int_input_ptr) = int_input;
        static IEC_UINT *(*int_output_ptr) = int_output;
        static IEC_UINT *(*int_memory_ptr) = int_memory;
        static IEC_UDINT *(*dint_memory_ptr) = dint_memory;
        static IEC_ULINT *(*lint_memory_ptr) = lint_memory;

    #endif


#else

    #define BUFFER_SIZE		1024

    //Internal buffers for I/O and memory. These buffers are defined in the
    //main program

    //Booleans
    static IEC_BOOL *(*bool_input_ptr)[8] = NULL;
    static IEC_BOOL *(*bool_output_ptr)[8] = NULL;

    //Bytes
    static IEC_BYTE *(*byte_input_ptr) = NULL;
    static IEC_BYTE *(*byte_output_ptr) = NULL;

    //Analog I/O
    static IEC_UINT *(*int_input_ptr) = NULL;
    static IEC_UINT *(*int_output_ptr) = NULL;

    //32bit I/O
    static IEC_UDINT *(*dint_input_ptr) = NULL;
    static IEC_UDINT *(*dint_output_ptr) = NULL;

    //64bit I/O
    static IEC_ULINT *(*lint_input_ptr) = NULL;
    static IEC_ULINT *(*lint_output_ptr) = NULL;

    //Memory
    static IEC_UINT *(*int_memory_ptr) = NULL;
    static IEC_UDINT *(*dint_memory_ptr) = NULL;
    static IEC_ULINT *(*lint_memory_ptr) = NULL;
#ifdef OPENPLC_V4
    static IEC_BOOL *(*bool_memory_ptr)[8] = NULL;
#endif

    void setBufferPointers(IEC_BOOL *input_bool[BUFFER_SIZE][8], IEC_BOOL *output_bool[BUFFER_SIZE][8],
                            IEC_BYTE *input_byte[BUFFER_SIZE], IEC_BYTE *output_byte[BUFFER_SIZE],
                            IEC_UINT *input_int[BUFFER_SIZE], IEC_UINT *output_int[BUFFER_SIZE],
                            IEC_UDINT *input_dint[BUFFER_SIZE], IEC_UDINT *output_dint[BUFFER_SIZE],
                            IEC_ULINT *input_lint[BUFFER_SIZE], IEC_ULINT *output_lint[BUFFER_SIZE],
                            IEC_UINT *int_memory[BUFFER_SIZE], IEC_UDINT *dint_memory[BUFFER_SIZE], 
                            IEC_ULINT *lint_memory[BUFFER_SIZE])
    {
        bool_input_ptr = input_bool;
        bool_output_ptr = output_bool;
        byte_input_ptr = input_byte;
        byte_output_ptr = output_byte;
        int_input_ptr = input_int;
        int_output_ptr = output_int;
        dint_input_ptr = input_dint;
        dint_output_ptr = output_dint;
        lint_input_ptr = input_lint;
        lint_output_ptr = output_lint;
        int_memory_ptr = int_memory;
        dint_memory_ptr = dint_memory;
        lint_memory_ptr = lint_memory;
    }

#ifdef OPENPLC_V4
    void setBufferPointers_v4(IEC_BOOL *input_bool[BUFFER_SIZE][8], IEC_BOOL *output_bool[BUFFER_SIZE][8],
                            IEC_BYTE *input_byte[BUFFER_SIZE], IEC_BYTE *output_byte[BUFFER_SIZE],
                            IEC_UINT *input_int[BUFFER_SIZE], IEC_UINT *output_int[BUFFER_SIZE],
                            IEC_UDINT *input_dint[BUFFER_SIZE], IEC_UDINT *output_dint[BUFFER_SIZE],
                            IEC_ULINT *input_lint[BUFFER_SIZE], IEC_ULINT *output_lint[BUFFER_SIZE],
                            IEC_UINT *int_memory[BUFFER_SIZE], IEC_UDINT *dint_memory[BUFFER_SIZE],
                            IEC_ULINT *lint_memory[BUFFER_SIZE], IEC_BOOL *memory_bool[BUFFER_SIZE][8])
    {
        // Call the base function to set all standard pointers
        setBufferPointers(input_bool, output_bool, input_byte, output_byte,
                          input_int, output_int, input_dint, output_dint,
                          input_lint, output_lint, int_memory, dint_memory, lint_memory);
        // Set the v4-specific bool_memory pointer
        bool_memory_ptr = memory_bool;
    }
#endif
#endif

void glueVars()
{
    {% for v in vars %}
    {{ v.glue_code }}
    {% endfor %}
}

void updateTime()
{
    __CURRENT_TIME.tv_sec  += common_ticktime__ / 1000000000ULL;
    __CURRENT_TIME.tv_nsec += common_ticktime__ % 1000000000ULL;

    if (__CURRENT_TIME.tv_nsec >= 1000000000ULL)
    {
        __CURRENT_TIME.tv_nsec -= 1000000000ULL;
        __CURRENT_TIME.tv_sec += 1;
    }
}

// Unity build for Arduino: Include other generated source files to compile as single unit.
// This ensures static functions are only compiled once, reducing binary size.
// These files are renamed to .inc to prevent separate compilation by Arduino build system.
#ifdef ARDUINO
#include "POUS.inc"
#include "Res0.inc"
#include "Config0.inc"
#endif
